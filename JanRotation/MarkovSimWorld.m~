classdef MarkovSimWorld < handle
    properties
        As
        C
        muInit
        initVar
        emitVar
        endT
        dt
        TRANS
        EMIS
        endI
        allT
        allAs        
        blankZs
        blankYs
    end
    
    methods
        function obj = MarkovSimWorld(varargin)
            props = properties(obj);
            for v = varargin
                obj.(props{1}) = v{1};
                props = props(2:end);
            end
            
            if ~exist('obj.emitVar', 'var') || isempty(obj.emitVar)
                obj.emitVar = obj.initVar;
            end
            
            obj.endI = ceil(obj.endT/obj.dt);
            obj.allT = 0:obj.dt:obj.endI*obj.dt;
            
            obj.allAs = @() obj.getAllAs();
            
            obj.blankZs = NaN(length(obj.muInit), obj.endI+1);
            obj.blankYs = NaN(min(size(obj.C)), obj.endI+1);
        end
        
        function [Zs, Ys] = getStates(obj)
            Z = (obj.muInit + sqrt(obj.initVar).*randn(size(obj.muInit)));
            randos = mvnrnd(zeros(min(size(obj.C)),1), obj.C*diag(obj.emitVar)*obj.C', obj.endI+1)';
            Zs = obj.blankZs;
            Ys = obj.blankYs;
            theseAs = obj.allAs;
            for i = 1:size(theseAs,3)
                Zs(:,i) = theseAs(:,:,i)*Z;
                Ys(:,i) = obj.C*Zs(:,i) + randos(:,i);
            end
        end
        
        function allAs = getAllAs(obj)
            seq = hmmgenerate(obj.endI, obj.TRANS, obj.EMIS);
            allAs = cumMtimes(obj.As(seq));
        end
    end
    
end